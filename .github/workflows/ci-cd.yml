name: ci-cd-backend
on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: wedding-backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cleanup:
    runs-on: self-hosted
    steps:
      - name: Clean workspace with proper permissions
        run: |
          sudo rm -rf ${{ github.workspace }} || true
          mkdir -p ${{ github.workspace }}

  ci-tests:
    runs-on: self-hosted
    needs: cleanup
    container:
      image: python:3.11
      options: --user 1001
    steps:
      - uses: actions/checkout@v4
        with:
          clean: true
      - name: Install deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run tests
        run: |
          if command -v pytest >/dev/null 2>&1; then pytest -q; else echo "pytest not found, skipping"; fi

  build-and-deploy:
    runs-on: self-hosted
    needs: ci-tests
    steps:
      - uses: actions/checkout@v4
        with:
          clean: true
      - name: Sync to /srv/wedding/backend
        run: rsync -a --delete --exclude='.git' ./ /srv/wedding/backend/
      - name: Build backend image
        run: docker compose -f /srv/wedding/docker-compose.yml build --no-cache backend
      - name: Start/Update backend
        run: docker compose -f /srv/wedding/docker-compose.yml up -d --no-deps backend
      - name: Cleanup dangling images
        run: docker image prune -f
